{% extends "base.html" %}
{% block title %}Ph√¢n T√≠ch AHP Mua ƒê·ªì ƒêi·ªán T·ª≠{% endblock %}

{% block content %}
<form method="POST" id="ahpForm" action="{{ url_for('index') }}">
    {# ... (Ph·∫ßn B∆∞·ªõc 1: So s√°nh ti√™u ch√≠ gi·ªØ nguy√™n nh∆∞ code ho√†n ch·ªânh l·∫ßn tr∆∞·ªõc) ... #}
    <h2>B∆∞·ªõc 1: So s√°nh c·∫∑p c√°c Ti√™u ch√≠</h2>
    <p>ƒê√°nh gi√° m·ª©c ƒë·ªô quan tr·ªçng t∆∞∆°ng ƒë·ªëi gi·ªØa c√°c c·∫∑p ti√™u ch√≠ theo thang ƒëi·ªÉm t·ª´ 1 ƒë·∫øn 9 (1: Ngang nhau, 9: C·ª±c k·ª≥ quan tr·ªçng h∆°n).</p>
    <table class="comparison-matrix">
        <thead>
            <tr>
                <th>Ti√™u ch√≠</th>
                {% for crit_name in criteria_names %}
                <th>{{ crit_name }}</th>
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for i in range(num_criteria) %}
            <tr>
                <td><strong>{{ criteria_names[i] }}</strong></td>
                {% for j in range(num_criteria) %}
                <td>
                    {% if i == j %}
                        <input type="text" value="1" readonly class="readonly-input">
                    {% elif i < j %}
                        <input type="number" name="compare_{{i}}_{{j}}" min="1" max="9" step="1" 
                               value="{{ submitted_data.get('compare_' + i|string + '_' + j|string, (criteria_results.comparison_matrix[i][j] if criteria_results and criteria_results.comparison_matrix else '')) }}" 
                               required class="editable-input criteria-compare-input">
                    {% else %}
                        <input type="text" id="auto_compare_{{i}}_{{j}}" readonly class="readonly-input auto-filled"
                               value="{{ (1 / (criteria_results.comparison_matrix[j][i]|float(1)))|round(4) if criteria_results and criteria_results.comparison_matrix and criteria_results.comparison_matrix[j][i] and criteria_results.comparison_matrix[j][i] != 0 else '' }}">
                    {% endif %}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
        </tbody>
    </table>
    <div style="margin-top: 15px;">
        <button type="submit" name="action" value="calculate_criteria" class="button">T√≠nh Tr·ªçng S·ªë & Ki·ªÉm Tra Nh·∫•t Qu√°n Ti√™u Ch√≠</button>
    </div>

    {% if criteria_results %}
    {# ... (Ph·∫ßn hi·ªÉn th·ªã criteria_results gi·ªØ nguy√™n nh∆∞ code ho√†n ch·ªânh l·∫ßn tr∆∞·ªõc) ... #}
    <div id="criteriaResultsArea" style="margin-top: 30px;">
        <h3>K·∫øt qu·∫£ ki·ªÉm tra t√≠nh nh·∫•t qu√°n Ti√™u ch√≠</h3>
        <p>Eigenvalue l·ªõn nh·∫•t (Œªmax): {{ "%.4f"|format(criteria_results.lambda_max) if criteria_results.lambda_max is not none }}</p>
        <p>Ch·ªâ s·ªë nh·∫•t qu√°n (CI): {{ "%.4f"|format(criteria_results.ci) if criteria_results.ci is not none }}</p>
        <p>T·ª∑ l·ªá nh·∫•t qu√°n (CR): {{ "%.4f"|format(criteria_results.cr) if criteria_results.cr is not none }}
            <span style="font-weight: bold; color: {% if criteria_results.is_consistent %}green{% else %}red{% endif %};">
                ({% if criteria_results.is_consistent %}Ma tr·∫≠n nh·∫•t qu√°n. Tr·ªçng s·ªë ƒë√°ng tin c·∫≠y.{% else %}Ma tr·∫≠n KH√îNG nh·∫•t qu√°n! C·∫ßn xem l·∫°i.{% endif %})
            </span>
        </p>
        <h3>Tr·ªçng s·ªë c√°c Ti√™u ch√≠ (Vector ∆∞u ti√™n)</h3>
        <table><thead><tr><th>Ti√™u ch√≠</th><th>Tr·ªçng s·ªë</th></tr></thead><tbody>
            {% for i in range(criteria_results.criteria_names|length) %}
            <tr><td>{{ criteria_results.criteria_names[i] }}</td><td>{{ "%.4f"|format(criteria_results.weights[i]) }}</td></tr>
            {% endfor %}
        </tbody></table>
        {% if criteria_results.normalized_matrix_by_col %}
        <h3>Ma tr·∫≠n chu·∫©n h√≥a theo c·ªôt (Tham kh·∫£o)</h3>
        <table class="comparison-matrix"><thead><tr><th>Ti√™u ch√≠</th>{% for cn in criteria_results.criteria_names %}<th>{{ cn }}</th>{% endfor %}</tr></thead><tbody>
        {% for i in range(criteria_results.criteria_names|length) %}<tr><td><strong>{{ criteria_results.criteria_names[i] }}</strong></td>
        {% for j in range(criteria_results.criteria_names|length) %}<td>{{ "%.4f"|format(criteria_results.normalized_matrix_by_col[i][j]) }}</td>{% endfor %}</tr>{% endfor %}
        </tbody></table>
        {% endif %}
    </div><hr>
    {% endif %}

    <div id="alternativesSection" {% if not criteria_results or not criteria_results.is_consistent %}style="display:none;"{% endif %}>
        <h2>B∆∞·ªõc 2: Nh·∫≠p th√¥ng tin Ph∆∞∆°ng √°n v√† ƒê√°nh gi√°</h2>
        <div class="form-group">
            <label for="num_alternatives">Ch·ªçn s·ªë l∆∞·ª£ng Ph∆∞∆°ng √°n (3-5):</label>
            <select name="num_alternatives" id="num_alternatives">
                {# ƒê·∫∑t gi√° tr·ªã m·∫∑c ƒë·ªãnh l√† 3 n·∫øu kh√¥ng c√≥ g√¨ kh√°c #}
                {% set current_num_alts_val = (submitted_data.get('num_alternatives')|int if submitted_data and submitted_data.get('num_alternatives') else (ahp_final_results.num_alternatives_processed if ahp_final_results else 3)) %}
                <option value="3" {% if current_num_alts_val == 3 %}selected{% endif %}>3 Ph∆∞∆°ng √°n</option>
                <option value="4" {% if current_num_alts_val == 4 %}selected{% endif %}>4 Ph∆∞∆°ng √°n</option>
                <option value="5" {% if current_num_alts_val == 5 %}selected{% endif %}>5 Ph∆∞∆°ng √°n</option>
            </select>
        </div>
        <table id="alternativesTable"><thead><tr><th>T√™n Ph∆∞∆°ng √°n</th>
        {% for crit_name in criteria_names %}<th>{{ crit_name }}<br><select name="crit_type_{{ loop.index0 }}" class="crit-type-select">
        {% set selected_crit_type_val = (submitted_data.get('crit_type_' + loop.index0|string) if submitted_data else (ahp_final_results.criteria_types[loop.index0] if ahp_final_results and ahp_final_results.criteria_types and loop.index0 < ahp_final_results.criteria_types|length else 'benefit')) %}
        <option value="benefit" {% if selected_crit_type_val == 'benefit' %}selected{% endif %}>Benefit</option>
        <option value="cost" {% if selected_crit_type_val == 'cost' %}selected{% endif %}>Cost</option>
        </select></th>{% endfor %}</tr></thead><tbody id="alternativesTbody"></tbody></table>
        <div style="margin-top: 20px;">
            <button type="submit" name="action" value="calculate_full_ahp" class="button" onclick="setAlternativeInputsRequired(true)">T√≠nh To√°n AHP Ho√†n Ch·ªânh</button>
            <button type="button" onclick="submitForExcel()" class="button">Xu·∫•t Excel (K·∫øt qu·∫£ hi·ªán t·∫°i)</button>
        </div>
    </div>
</form>
<hr>

{% if ahp_final_results %}
{# ... (Ph·∫ßn hi·ªÉn th·ªã k·∫øt qu·∫£ cu·ªëi c√πng v√† bi·ªÉu ƒë·ªì gi·ªØ nguy√™n nh∆∞ code ho√†n ch·ªânh l·∫ßn tr∆∞·ªõc) ... #}
<div id="finalResultsArea">
    <h2>K·∫øt Qu·∫£ Ph√¢n T√≠ch AHP Ho√†n Ch·ªânh</h2>
    <p>T·ª∑ s·ªë nh·∫•t qu√°n (CR) Ti√™u ch√≠: {{ "%.4f"|format(ahp_final_results.cr) }} 
        <span style="font-weight: bold;color:{%if ahp_final_results.cr <=0.1%}green{%else%}red{%endif%};">({%if ahp_final_results.cr <=0.1%}ƒê·∫°t{%else%}KH√îNG ƒê·∫°t{%endif%})</span></p>
    <h3>B·∫£ng K·∫øt Qu·∫£ Chi Ti·∫øt Ph∆∞∆°ng √Ån</h3>
    <table><thead><tr><th>H·∫°ng</th><th>T√™n Ph∆∞∆°ng √°n</th>
    {% for cn_h in ahp_final_results.criteria_names %}<th>{{cn_h}}(G·ªëc)</th>{% endfor %}
    {% for cn_h in ahp_final_results.criteria_names %}<th>{{cn_h}}(CH)</th>{% endfor %}
    <th>ƒêi·ªÉm T·ªïng H·ª£p</th></tr></thead><tbody>
    {% for alt in ahp_final_results.ranked_alternatives %}<tr><td>{{alt.rank}}</td><td>{{alt.name}}</td>
    {% for score in alt.raw_scores %}<td>{{"%.2f"|format(score)}}</td>{% endfor %}
    {% for sn in alt.normalized_scores %}<td>{{"%.4f"|format(sn)}}</td>{% endfor %}
    <td><strong>{{"%.4f"|format(alt.overall_score)}}</strong></td></tr>{% endfor %}</tbody></table>
    {% if ahp_final_results.ranked_alternatives %}<h3 style="color:green;margin-top:15px;">üèÜ ƒê·ªÅ xu·∫•t: {{ahp_final_results.ranked_alternatives[0].name}} (ƒêi·ªÉm: {{"%.4f"|format(ahp_final_results.ranked_alternatives[0].overall_score)}})</h3>{% endif %}<hr>
    <h2>Bi·ªÉu ƒê·ªì Tr·ª±c Quan</h2><div style="display:flex;justify-content:space-around;flex-wrap:wrap;">
    <div style="width:45%;min-width:300px;margin-bottom:20px;"><h3>Tr·ªçng s·ªë Ti√™u ch√≠</h3><canvas id="criteriaChartFinal"></canvas></div>
    <div style="width:45%;min-width:300px;margin-bottom:20px;"><h3>ƒêi·ªÉm Ph∆∞∆°ng √°n</h3><canvas id="alternativesChartFinal"></canvas></div></div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const numCriteria = parseInt("{{ num_criteria }}");
    
    function updateReciprocalValue(rowIdx, colIdx, inputValue) {
        const reciprocalElement = document.getElementById(`auto_compare_${colIdx}_${rowIdx}`);
        if (reciprocalElement) {
            const numVal = parseInt(inputValue);
            reciprocalElement.value = (!isNaN(numVal) && numVal >= 1 && numVal <= 9) ? (1 / numVal).toFixed(4) : '';
        }
    }

    for (let i = 0; i < numCriteria; i++) {
        for (let j = i + 1; j < numCriteria; j++) {
            const el = document.querySelector(`input[name="compare_${i}_${j}"]`);
            if (el) {
                el.addEventListener('input', function() { updateReciprocalValue(i, j, this.value); });
                // G·ªçi ƒë·ªÉ c·∫≠p nh·∫≠t gi√° tr·ªã ngh·ªãch ƒë·∫£o ban ƒë·∫ßu n·∫øu input compare_i_j c√≥ gi√° tr·ªã
                // (t·ª´ submitted_data ho·∫∑c criteria_results.comparison_matrix)
                if (el.value) { updateReciprocalValue(i, j, el.value); }
            }
        }
    }
    
    const numAltSelect = document.getElementById('num_alternatives');
    const altTbody = document.getElementById('alternativesTbody');
    const critNamesJS = JSON.parse('{{ criteria_names|tojson|safe }}');
    // L·∫•y submitted_data t·ª´ Flask, n·∫øu kh√¥ng c√≥ th√¨ l√† object r·ªóng
    // ƒêi·ªÅu n√†y quan tr·ªçng ƒë·ªÉ ƒëi·ªÅn l·∫°i form sau khi submit l·ªói ho·∫∑c khi t√≠nh xong ti√™u ch√≠
    const submittedJS = JSON.parse('{{ submitted_data|tojson|safe if submitted_data else "{}"|safe }}');
    const finalResultsJS = JSON.parse('{{ ahp_final_results|tojson|safe if ahp_final_results else "null" }}');

    function updateAlternativeRowsAndInputs(countStr) {
        const count = parseInt(countStr);
        if (!altTbody || isNaN(count) || count < 3 || count > 5) {
            console.error("L·ªói khi c·∫≠p nh·∫≠t h√†ng ph∆∞∆°ng √°n. Element tbody ho·∫∑c count kh√¥ng h·ª£p l·ªá.");
            return;
        }
        altTbody.innerHTML = ''; // X√≥a c√°c h√†ng c≈©
        for (let i = 0; i < count; i++) {
            const row = altTbody.insertRow();
            const cellName = row.insertCell();
            
            let altNameVal = `Ph∆∞∆°ng √°n ${i + 1}`;
            // ∆Øu ti√™n l·∫•y t·ª´ d·ªØ li·ªáu form ƒë√£ submit (n·∫øu c√≥) khi ng∆∞·ªùi d√πng thay ƒë·ªïi dropdown
            // ho·∫∑c khi trang t·∫£i l·∫°i sau l·ªói submit.
            // N·∫øu kh√¥ng c√≥ submittedJS cho t√™n n√†y, m·ªõi d√πng finalResultsJS (n·∫øu c√≥)
            if (submittedJS && submittedJS[`alt_name_${i}`] !== undefined) {
                altNameVal = submittedJS[`alt_name_${i}`];
            } else if (finalResultsJS && finalResultsJS.ranked_alternatives && i < finalResultsJS.ranked_alternatives.length) {
                altNameVal = finalResultsJS.ranked_alternatives[i].name;
            }
            cellName.innerHTML = `<input type="text" class="alt-input alt-name-input" name="alt_name_${i}" value="${altNameVal}" placeholder="T√™n PA ${i+1}">`;
            
            critNamesJS.forEach((critName, j) => {
                const cellScore = row.insertCell();
                let scoreVal = '';
                if (submittedJS && submittedJS[`score_${i}_${j}`] !== undefined) {
                    scoreVal = submittedJS[`score_${i}_${j}`];
                } else if (finalResultsJS && finalResultsJS.ranked_alternatives && i < finalResultsJS.ranked_alternatives.length && 
                           finalResultsJS.ranked_alternatives[i].raw_scores && j < finalResultsJS.ranked_alternatives[i].raw_scores.length) {
                    scoreVal = finalResultsJS.ranked_alternatives[i].raw_scores[j];
                }
                // Th√™m min="0" ƒë·ªÉ kh√¥ng cho nh·∫≠p s·ªë √¢m
                cellScore.innerHTML = `<input type="number" step="any" min="0" class="alt-input alt-score-input" name="score_${i}_${j}" value="${scoreVal}" placeholder="ƒêi·ªÉm">`;
            });
        }
    }
    
    if (numAltSelect) { 
        updateAlternativeRowsAndInputs(numAltSelect.value); // G·ªçi l·∫ßn ƒë·∫ßu ƒë·ªÉ t·∫°o b·∫£ng
        
        // QUAN TR·ªåNG: Th√™m event listener cho select box ƒë·ªÉ c·∫≠p nh·∫≠t khi ng∆∞·ªùi d√πng thay ƒë·ªïi
        numAltSelect.addEventListener('change', function() {
            updateAlternativeRowsAndInputs(this.value);
        });
    }

    const altSection = document.getElementById('alternativesSection');
    {% if criteria_results and criteria_results.is_consistent %}
        if(altSection) altSection.style.display = 'block';
    {% elif criteria_results and not criteria_results.is_consistent %}
        // alert("C·∫£nh b√°o: Ma tr·∫≠n ti√™u ch√≠ kh√¥ng nh·∫•t qu√°n."); // T√πy ch·ªçn
        if(altSection) altSection.style.display = 'block'; 
    {% else %}
        if(altSection) altSection.style.display = 'none';
    {% endif %}

    // V·∫Ω bi·ªÉu ƒë·ªì (gi·ªØ nguy√™n logic n√†y)
    {% if ahp_final_results and ahp_final_results.chart_crit_names %}
    try {
        const critChartData = { labels: JSON.parse('{{ ahp_final_results.chart_crit_names|tojson|safe }}'), datasets: [{ label: 'Tr·ªçng s·ªë Ti√™u ch√≠', data: JSON.parse('{{ ahp_final_results.chart_crit_weights|tojson|safe }}'), backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0'], borderColor:['#fff'], borderWidth:1 }]};
        const critCtx = document.getElementById('criteriaChartFinal')?.getContext('2d');
        if(critCtx) new Chart(critCtx, {type:'pie', data:critChartData, options:{responsive:true,plugins:{legend:{position:'top'}}}});
    } catch(e) { console.error("L·ªói v·∫Ω bi·ªÉu ƒë·ªì ti√™u ch√≠ (final):", e); }

    try {
        const altChartData = { labels: JSON.parse('{{ ahp_final_results.chart_alt_names|tojson|safe }}'), datasets: [{ label: 'ƒêi·ªÉm T·ªïng h·ª£p Ph∆∞∆°ng √°n', data: JSON.parse('{{ ahp_final_results.chart_alt_scores|tojson|safe }}'), backgroundColor:'#4BC0C0', borderColor:'#30a0a0', borderWidth:1 }]};
        const altCtx = document.getElementById('alternativesChartFinal')?.getContext('2d');
        if(altCtx) new Chart(altCtx, {type:'bar', data:altChartData, options:{responsive:true,scales:{y:{beginAtZero:true}}}});
    } catch(e) { console.error("L·ªói v·∫Ω bi·ªÉu ƒë·ªì ph∆∞∆°ng √°n (final):", e); }
    {% endif %}
});

function setAlternativeInputsRequired(isRequired) {
    const altInputs = document.querySelectorAll('#alternativesTbody .alt-input');
    altInputs.forEach(input => {
        if (isRequired) { input.setAttribute('required', 'required'); } 
        else { input.removeAttribute('required'); }
    });
}

const mainForm = document.getElementById('ahpForm');
if (mainForm) {
    mainForm.addEventListener('submit', function(event) {
        const actionButton = document.activeElement; 
        if (actionButton && actionButton.name === 'action') {
            if (actionButton.value === 'calculate_full_ahp') { setAlternativeInputsRequired(true); } 
            else if (actionButton.value === 'calculate_criteria') { setAlternativeInputsRequired(false); }
        }
    });
}

function submitForExcel() {
    const form = document.getElementById('ahpForm');
    setAlternativeInputsRequired(false); 
    form.action = "{{ url_for('export_excel_current') }}"; 
    form.method = "POST"; 
    form.submit();
}
</script>
{% endblock %}