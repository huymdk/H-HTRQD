{% extends "base.html" %}
{% block title %}K·∫øt Qu·∫£ Quy·∫øt ƒê·ªãnh: {{ results.decision_info.decision_name if results and results.decision_info else "Kh√¥ng r√µ" }}{% endblock %}

{% block content %}
    {% if results and results.decision_info %}
        <h2>K·∫øt Qu·∫£ Ph√¢n T√≠ch AHP cho: {{ results.decision_info.decision_name }}</h2>
        <p><em>(Quy·∫øt ƒë·ªãnh ID: {{ results.decision_info.decision_id }}, L∆∞u ng√†y: {{ results.decision_info.creation_date.strftime('%d-%m-%Y %H:%M') if results.decision_info.creation_date else 'N/A' }})</em></p>
        <p>M√¥ t·∫£: {{ results.decision_info.description or "Kh√¥ng c√≥ m√¥ t·∫£."}}</p>
    {% else %}
        <h2>Kh√¥ng t√¨m th·∫•y th√¥ng tin quy·∫øt ƒë·ªãnh</h2>
    {% endif %}

    {% if results %}
        {# Hi·ªÉn th·ªã Ma tr·∫≠n so s√°nh ti√™u ch√≠ n·∫øu c√≥ d·ªØ li·ªáu #}
        {% if results.comparison_matrix and results.criteria_names and results.comparison_matrix|length == results.criteria_names|length %}
        <h3>Ma tr·∫≠n So s√°nh C·∫∑p Ti√™u ch√≠ (ƒê√£ l∆∞u)</h3>
        <table class="comparison-matrix">
             <thead>
                <tr>
                    <th>Ti√™u ch√≠</th>
                    {% for crit_name in results.criteria_names %}
                    <th>{{ crit_name }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody>
            {% for i in range(results.criteria_names|length) %}
            <tr>
                <td><strong>{{ results.criteria_names[i] }}</strong></td>
                {% for j in range(results.criteria_names|length) %}
                <td>
                    {# ƒê·∫£m b·∫£o truy c·∫≠p ph·∫ßn t·ª≠ trong ma tr·∫≠n m·ªôt c√°ch an to√†n #}
                    {{ "%.4f"|format(results.comparison_matrix[i][j]) if results.comparison_matrix[i] and j < results.comparison_matrix[i]|length else 'N/A' }}
                </td>
                {% endfor %}
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p><em>Kh√¥ng c√≥ d·ªØ li·ªáu chi ti·∫øt ma tr·∫≠n so s√°nh ti√™u ch√≠ ƒë∆∞·ª£c l∆∞u ho·∫∑c d·ªØ li·ªáu kh√¥ng ƒë·∫ßy ƒë·ªß.</em></p>
        {% endif %}

        <h3>Th√¥ng s·ªë Ma tr·∫≠n Ti√™u ch√≠ (ƒê√£ l∆∞u)</h3>
        <p>T·ª∑ s·ªë nh·∫•t qu√°n (CR): 
            {% if results.cr is not none %} {# S·ª¨A ·ªû ƒê√ÇY: d√πng results.cr #}
                {{ "%.4f"|format(results.cr) }}
                <span style="font-weight: bold;color:{%if results.cr <=0.1%}green{%else%}red{%endif%};">
                    ({%if results.cr <=0.1%}ƒê·∫°t nh·∫•t qu√°n{%else%}KH√îNG ƒë·∫°t nh·∫•t qu√°n{%endif%})
                </span>
            {% else %}
                Kh√¥ng c√≥ d·ªØ li·ªáu CR
            {% endif %}
        </p>
        <h3>Tr·ªçng s·ªë c√°c Ti√™u ch√≠ (ƒê√£ l∆∞u)</h3>
        {% if results.criteria_names and results.criteria_weights and results.criteria_names|length == results.criteria_weights|length %}
         <table>
            <thead><tr><th>Ti√™u ch√≠</th><th>Tr·ªçng s·ªë</th></tr></thead>
            <tbody>
             {% for i in range(results.criteria_names|length) %}
             <tr>
                <td>{{ results.criteria_names[i] }}</td>
                <td>{{ "%.4f"|format(results.criteria_weights[i]) if results.criteria_weights[i] is not none else 'N/A' }}</td>
            </tr>
             {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p><em>Kh√¥ng c√≥ d·ªØ li·ªáu tr·ªçng s·ªë ti√™u ch√≠ ho·∫∑c d·ªØ li·ªáu kh√¥ng kh·ªõp.</em></p>
        {% endif %}


        <h3>B·∫£ng K·∫øt Qu·∫£ Chi Ti·∫øt Ph∆∞∆°ng √Ån (ƒê√£ l∆∞u)</h3>
        {% if results.ranked_alternatives %}
        <table>
            <thead>
                <tr>
                    <th>H·∫°ng</th>
                    <th>T√™n Ph∆∞∆°ng √°n</th>
                    {% for cn_h in results.criteria_names %}<th>{{cn_h}}(G·ªëc)</th>{% endfor %}
                    {% for cn_h in results.criteria_names %}<th>{{cn_h}}(CH)</th>{% endfor %}
                    <th>ƒêi·ªÉm T·ªïng H·ª£p</th>
                </tr>
            </thead>
            <tbody>
            {% for alt in results.ranked_alternatives %}
            <tr>
                <td>{{ alt.rank_value if alt.rank_value is not none else alt.get('rank', 'N/A') }}</td>
                <td>{{ alt.alternative_name if alt.alternative_name is not none else alt.get('name', 'N/A') }}</td>
                {# Hi·ªÉn th·ªã ƒëi·ªÉm g·ªëc v√† chu·∫©n h√≥a t·ª´ scores_detail, ƒë·∫£m b·∫£o ƒë√∫ng th·ª© t·ª± ti√™u ch√≠ #}
                {% for crit_name_expected in results.criteria_names %}
                    {% set raw_score_val = namespace(value='N/A') %}
                    {% for score_item in alt.scores_detail if score_item.criterion_name == crit_name_expected %}
                        {% if score_item.raw_score is not none %}{% set raw_score_val.value = "%.2f"|format(score_item.raw_score) %}{% endif %}
                    {% endfor %}
                    <td>{{ raw_score_val.value }}</td>
                {% endfor %}
                {% for crit_name_expected in results.criteria_names %}
                    {% set norm_score_val = namespace(value='N/A') %} {# ƒê·ªïi t√™n bi·∫øn namespace ƒë·ªÉ tr√°nh xung ƒë·ªôt n·∫øu c·∫ßn #}
                    {% for score_item_norm in alt.scores_detail if score_item_norm.criterion_name == crit_name_expected %}
                        {% if score_item_norm.normalized_score is not none %}{% set norm_score_val.value = "%.4f"|format(score_item_norm.normalized_score) %}{% endif %}
                    {% endfor %}
                    <td>{{ norm_score_val.value }}</td>
                {% endfor %}
                <td><strong>{{ "%.4f"|format(alt.overall_score) if alt.overall_score is not none else 'N/A' }}</strong></td>
            </tr>
            {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p>Kh√¥ng c√≥ d·ªØ li·ªáu ph∆∞∆°ng √°n cho quy·∫øt ƒë·ªãnh n√†y.</p>
        {% endif %}

        {% if results.ranked_alternatives and results.ranked_alternatives[0].overall_score is not none %}
        <h3 style="color: green; margin-top: 15px;">üèÜ Ph∆∞∆°ng √°n ƒë∆∞·ª£c ƒë·ªÅ xu·∫•t: {{ results.ranked_alternatives[0].alternative_name }} (ƒêi·ªÉm: {{ "%.4f"|format(results.ranked_alternatives[0].overall_score) }})</h3>
        {% endif %}

        <hr>
        <h2>Bi·ªÉu ƒê·ªì Tr·ª±c Quan (T·ª´ D·ªØ Li·ªáu ƒê√£ L∆∞u)</h2>
        <div style="display: flex; justify-content: space-around; flex-wrap: wrap;">
            <div style="width: 45%; min-width: 300px; margin-bottom: 20px;">
                <h3>Bi·ªÉu ƒë·ªì Tr·ªçng s·ªë Ti√™u ch√≠</h3><canvas id="criteriaWeightsChart"></canvas>
            </div>
            <div style="width: 45%; min-width: 300px; margin-bottom: 20px;">
                <h3>Bi·ªÉu ƒë·ªì ƒêi·ªÉm T·ªïng h·ª£p Ph∆∞∆°ng √°n</h3><canvas id="alternativesScoresChart"></canvas>
            </div>
        </div>
    {% else %}
        <p>Kh√¥ng c√≥ d·ªØ li·ªáu k·∫øt qu·∫£ chi ti·∫øt ƒë·ªÉ hi·ªÉn th·ªã cho quy·∫øt ƒë·ªãnh n√†y.</p>
    {% endif %}

    {% if results and results.decision_info %} {# Ch·ªâ hi·ªÉn th·ªã n√∫t n·∫øu c√≥ decision_info #}
    <div style="margin-top:30px;">
        <a href="{{ url_for('history') }}" class="button">Quay l·∫°i L·ªãch S·ª≠</a>
        <a href="{{ url_for('export_excel_history', decision_id=results.decision_info.decision_id) }}" class="button export-button" target="_blank">Xu·∫•t Excel Quy·∫øt ƒê·ªãnh N√†y</a>
    </div>
    {% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Ch·ªâ th·ª±c hi·ªán n·∫øu c√°c bi·∫øn results v√† c√°c key c·∫ßn thi·∫øt t·ªìn t·∫°i v√† c√≥ d·ªØ li·ªáu
    {% if results and results.chart_crit_names and results.chart_crit_weights and results.chart_crit_weights|length > 0 %}
    try {
        const criteriaChartData = {
            labels: JSON.parse('{{ results.chart_crit_names|tojson|safe }}'),
            datasets: [{ 
                label: 'Tr·ªçng s·ªë Ti√™u ch√≠', 
                data: JSON.parse('{{ results.chart_crit_weights|tojson|safe }}'),
                backgroundColor: ['#FF6384','#36A2EB','#FFCE56','#4BC0C0', '#9966FF', '#FF9F40'], 
                borderColor:['#fff'], borderWidth:1 
            }]
        };
        const criteriaCtx = document.getElementById('criteriaWeightsChart')?.getContext('2d');
        if(criteriaCtx) {
            new Chart(criteriaCtx, {type:'pie',data:criteriaChartData,options:{responsive:true,plugins:{legend:{position:'top'}}}});
        }
    } catch (e) { console.error("L·ªói v·∫Ω bi·ªÉu ƒë·ªì ti√™u ch√≠ (t·ª´ l·ªãch s·ª≠):", e); }
    {% else %}
        console.log("Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì tr·ªçng s·ªë ti√™u ch√≠.");
    {% endif %}

    {% if results and results.chart_alt_names and results.chart_alt_scores and results.chart_alt_scores|length > 0 %}
    try {
        const alternativesChartData = {
            labels: JSON.parse('{{ results.chart_alt_names|tojson|safe }}'),
            datasets: [{ 
                label: 'ƒêi·ªÉm T·ªïng h·ª£p Ph∆∞∆°ng √°n', 
                data: JSON.parse('{{ results.chart_alt_scores|tojson|safe }}'),
                backgroundColor:'#4BC0C0', borderColor:'#30a0a0', borderWidth:1 
            }]
        };
        const alternativesCtx = document.getElementById('alternativesScoresChart')?.getContext('2d');
        if(alternativesCtx) {
            new Chart(alternativesCtx, {type:'bar',data:alternativesChartData,options:{responsive:true,scales:{y:{beginAtZero:true}}}});
        }
    } catch (e) { console.error("L·ªói v·∫Ω bi·ªÉu ƒë·ªì ph∆∞∆°ng √°n (t·ª´ l·ªãch s·ª≠):", e); }
    {% else %}
        console.log("Kh√¥ng ƒë·ªß d·ªØ li·ªáu ƒë·ªÉ v·∫Ω bi·ªÉu ƒë·ªì ƒëi·ªÉm ph∆∞∆°ng √°n.");
    {% endif %}
});
</script>
{% endblock %}